<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
  <style>
    table { width: 100%; margin: 30px 0; }
    td { border: 1px solid #ccc; padding: 1em .5em;}
    p { text-align: center; }
  </style>
  <script type="text/template" id="quote-row">
    <td><%= context %></td>
    <td><%= source %></td>
    <td><%= theme %></td>
    <td><%= quote %></td>
  </script>
</head>
<body>
  <table>
    <thead>
      <tr>
        <th>Context</th>
        <th>Source</th>
        <th>Theme</th>
        <th>Quote</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>
    <label for="page">Page</label>
    <input id="page" type="number" step="1" min="1" value="1">
    of <input id="pages" type="number" value="12" min="1" disabled="true"> pages
  </p>
  <p>
    <label for="per_page">Per page</label>
    <input id="per_page" type="number" step="1" min="1" value="7" max="15">
  </p>
</body>
  <script>
    var Quote = Backbone.Model.extend();

    var QuotesCollection = Backbone.Collection.extend({
      url: "https://gist.githubusercontent.com/anonymous/8f61a8733ed7fa41c4ea/raw/1e90fd2741bb6310582e3822f59927eb535f6c73/quotes.json",
      model: Quote
    });

    var quotes = new QuotesCollection;

    // Create Quotes View
    var QuotesView = Backbone.View.extend({
      el: 'body',
      
      events: {
        "change #page": "updatePagination",
        "change #per_page": "updatePagination"
      },


      initialize: function() {
        this.updatePagination();
        this.render();
      },

      displayedQuotes: function() {
        startIndex = this.page() * this.perPage();
        return quotes.slice(startIndex, startIndex + this.perPage());
      },

      perPage: function() {
        return parseInt($('#per_page').val(), 10);
      },

      page: function() {
        return parseInt($('#page').val(), 10) - 1;
      },

      updatePagination: function() {
        // If values aren't allowed, reset and rerun the function
        if (this.perPage() > 15) {
          return this.updatePagination($('#per_page').val(15));
        }
        pages = Math.ceil(quotes.length / this.perPage(), 1);
        $('#pages').val(pages);
        $('#pages').prop('max', pages)
        $('#page').prop('max', pages)
        if (this.page() > pages) {
          return this.updatePagination($('#page').val(pages));
        }
        this.render();
      },

      render: function() {
        var $list = this.$('tbody').empty()
        // Calling slice on the collection doesn't return a collection, it returns
        // shallow copies of the models, which isn't ideal. 
        // But in this instance, I'm calling it good enough.
        _.each(this.displayedQuotes(), function(model) {
          var quote = new QuoteView({model: model});
          $list.append(quote.render().el);
        }.bind(this));
        return this;
      }
    });

    var QuoteView = Backbone.View.extend({
      tagName: 'tr',
      template: _.template($('#quote-row').html()),
      render: function() {
        this.$el.html(this.template(this.model.attributes));
        return this;
      }
    });

    quotes.fetch().then(function() { new QuotesView(); });
  </script>
</html>